<div class="container mx-auto px-4 py-8">
  <%= turbo_frame_tag "admin_users_list", data: { turbo_action: "advance" } do %>
    <div class="mb-6">
      <%# 表單連結 autosubmit controller 做「一更改資料就自動提交」 %>
      <%= search_form_for @q, url: admin_users_path, method: :get, data: { controller: "autosubmit", turbo_frame: "admin_users_list" }, class: "flex flex-col sm:flex-row justify-between items-center gap-4" do |f| %>
        
        <div class="flex flex-1 items-center gap-3 w-full sm:w-auto">
          <%# --- 搜尋框（Email 搜尋）--- %>
          <div class="relative w-full sm:w-64">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
              </svg>
            </div>
            <%= f.search_field :email_cont, 
                placeholder: t('admin.users.index.search'), 
                data: { action: "input->autosubmit#search" },              
                class: "pl-10 block w-full rounded-full border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 [&::-webkit-search-cancel-button]:hidden" %>

            <%# search filter 篩選邏輯 %>      
            <% if params[:q] && params[:q][:email_cont].present? %>
              <%# 清除按鈕 %> 
              <%= link_to admin_users_path(params_without_filter(:email_cont)), class: "absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" do %>
                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
              <% end %>
            <% end %>
          </div>

          <%= f.submit "Filter", class: "hidden" %>
        </div>

        <div class="flex items-center gap-4">
          <%# 排序篩選器下拉選單 %>
          <div class="relative group">
            <button type="button" class="flex items-center text-gray-500 text-sm gap-1 hover:text-gray-700 focus:outline-none">
              <span><%= t('admin.users.index.sorting') %></span>
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
            </button>

            <div class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl z-50 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200">
              <div class="py-1">
                <%= sort_link @q, :created_at, User.human_attribute_name(:created_at), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" %>
                <%= sort_link @q, :tasks_count, t('admin.users.index.tasks_count'), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" %>
              </div>
            </div>
          </div>

          <%# 新增使用者按鈕 %>
          <%= link_to new_admin_user_path, 
            { 
              class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition",
              data: { turbo_frame: "_top" }
            } do %>
            <svg class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            <%= t('admin.users.index.create_button') %>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# 使用者列表表格 %>
    <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
      <div class="overflow-x-auto">
        <table class="min-w-full leading-normal">
          
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
              <th class="px-5 py-3">
                <%= sort_link @q, :name, User.human_attribute_name(:name), class: "hover:text-gray-900 flex items-center" %>
              </th>
              <th class="px-5 py-3">
                <%= sort_link @q, :email, User.human_attribute_name(:email), class: "hover:text-gray-900 flex items-center" %>
              </th>
              <th class="px-5 py-3">
                <%= sort_link @q, :created_at, User.human_attribute_name(:created_at), class: "hover:text-gray-900 flex items-center" %>
              </th>
              <th class="px-5 py-3">
                <%= sort_link @q, :tasks_count, t('admin.users.index.tasks_count'), class: "hover:text-gray-900 flex items-center" %>
              </th>
              <th class="px-5 py-3 text-right">
                <%= t('common.actions') %> 
              </th>
            </tr>
          </thead>

          <tbody class="text-gray-700 text-sm font-light">
            <%# 無任何使用者的狀況 %>
            <% if @users.empty? %>
              <tr>
                <td colspan="5" class="px-5 py-8 text-center text-gray-500">
                  <%= t('admin.users.index.no_users') %>
                </td>
              </tr>
            <% else %>
              <% @users.each do |user| %>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition duration-150 ease-in-out">
                  
                  <%# 1. 名稱 %>
                  <td class="px-5 py-4">
                    <p class="font-medium text-gray-900 truncate max-w-[12rem]"><%= user.name %></p>
                  </td>

                  <%# 2. 電子郵件 %>
                  <td class="px-5 py-4">
                    <p class="text-gray-500 truncate max-w-[16rem]"><%= user.email %></p>
                  </td>

                  <%# 3. 建立時間 %>
                  <td class="px-5 py-4 text-gray-500">
                    <%= l(user.created_at, format: :short) %>
                  </td>

                  <%# 4. 任務數 %>
                  <td class="px-5 py-4">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-600">
                      <%= user.tasks_count %>
                    </span>
                  </td>

                  <%# 5. 操作按鈕 %>
                  <td class="px-5 py-4 text-right">
                    <div class="flex items-center justify-end space-x-3">
                      <%# 查看任務按鈕 %>
                      <%= link_to admin_user_tasks_path(user), 
                          class: "text-gray-400 hover:text-blue-600 transition duration-150", 
                          title: t('action.view_tasks'),
                          data: { turbo_frame: "_top" } do %>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11.7678 11.7678C12.2366 11.2989 12.5 10.663 12.5 10C12.5 9.33696 12.2366 8.70107 11.7678 8.23223C11.2989 7.76339 10.663 7.5 10 7.5C9.33696 7.5 8.70107 7.76339 8.23223 8.23223C7.76339 8.70107 7.5 9.33696 7.5 10C7.5 10.663 7.76339 11.2989 8.23223 11.7678C8.70107 12.2366 9.33696 12.5 10 12.5C10.663 12.5 11.2989 12.2366 11.7678 11.7678Z" stroke="#BEBEBE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2.04834 9.99999C3.11001 6.61916 6.26917 4.16666 10 4.16666C13.7317 4.16666 16.89 6.61916 17.9517 9.99999C16.89 13.3808 13.7317 15.8333 10 15.8333C6.26917 15.8333 3.11001 13.3808 2.04834 9.99999Z" stroke="#BEBEBE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      <% end %>

                      <%# 編輯按鈕 %>
                      <%= link_to edit_admin_user_path(user), 
                          class: "text-gray-400 hover:text-indigo-600 transition duration-150", 
                          title: t('action.edit'),
                          data: { turbo_frame: "_top" } do %>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                      <% end %>
                      
                      <%# 刪除按鈕 %>
                      <%= link_to admin_user_path(user), 
                          data: { 
                            turbo_method: :delete, 
                            turbo_confirm: t('admin.users.index.confirm_delete', name: user.name),
                            turbo_frame: "_top"
                          }, 
                          class: "text-gray-400 hover:text-red-600 transition duration-150",
                          title: t('action.delete') do %>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.052.68-.107 1.022-.166m-1.022.165L5.366 9.93m0 0-.209 9.081m0-9.081.209-9.081M10.5 2.25h3m-3 0a2.25 2.25 0 0 0-2.25 2.25v.912m7.5 0v-.912a2.25 2.25 0 0 0-2.25-2.25h-1.5" />
                        </svg>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @pagy.pages > 1 %>
        <div class="px-5 py-5 bg-white border-t border-gray-200 flex items-center justify-center">
          <div class="pagy-container text-sm text-gray-600">
            <%== pagy_nav(@pagy) %>
          </div>
        </div>
      <% end %>
      
    </div>
  <% end %>
</div>
