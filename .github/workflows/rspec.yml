name: Rails RSpec CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    name: Run RSpec Tests
    runs-on: ubuntu-latest
    
    # 1. 啟動資料庫服務 
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: task_management_system_test 
        ports:
          - 5432:5432
        # 健康檢查，確保 DB 準備好才開始跑測試
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 2. 取得專案程式碼
      - name: Check out code
        uses: actions/checkout@v4

      # 3. 設定 Ruby 環境
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.7' 
          bundler-cache: true  

      # 4. 準備測試資料庫
      # 這裡的 ENV 變數會覆蓋 database.yml 的設定
      - name: Set up database
        env:
          RAILS_ENV: test
          PG_HOST: 127.0.0.1
          PG_USER: postgres     # 覆蓋 user name 
          PG_PASSWORD: password # 覆蓋空白密碼 
        run: |
          bin/rails db:prepare

      # 5. 執行 RSpec 測試
      - name: Run RSpec
        env:
          RAILS_ENV: test
          PG_HOST: 127.0.0.1
          PG_USER: postgres     # 覆蓋 user name 
          PG_PASSWORD: password # 覆蓋空白密碼 
        run: |
          bundle exec rspec